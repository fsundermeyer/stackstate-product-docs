ifdef::ss-ff-stackpacks2_enabled[]
= Pour commencer
:revdate: 2025-12-23
:page-revdate: {revdate}
:description: Démarrage de la dérivation de la topologie à partir d'OpenTelemetry

== Vue d'ensemble

Ce document fournit un guide de démarrage pour construire une topologie à partir des données de trace d'OpenTelemetry (OTel) en utilisant des mappings de composants et de relations empaquetés dans le cadre d'un StackPack.

Ce guide se concentre sur la topologie qui peut être visualisée immédiatement dans le produit en utilisant les données de télémétrie déjà présentes.
L'exemple de topologie qui sera généré modélise la façon dont une instance de service exécute un processus, dérivé des attributs de ressources OpenTelemetry.

== Conditions préalables

* Vous collectez déjà des traces OpenTelemetry.
* Vous créez ou étendez un StackPack.
* Vous êtes à l'aise avec YAML et les concepts de base d'OTel (ressources, spans).

Le guide se concentre sur :

* Topologie basée sur les traces (signal`TRACES` uniquement)
* Instances de service (pas les services logiques)
* Visibilité du processus d'exécution

[NOTE]
====
Dans ce guide, les mappages de composants et de relations sont exprimés sous la forme d'une configuration YAML qui est empaquetée, testée et déployée dans le cadre d'un StackPack.
====

== Configuration de la topologie

L'objectif est de visualiser la topologie d'exécution immédiatement disponible sans configuration supplémentaire de la part de l'utilisateur.

Plus précisément, nous voulons modéliser :

[source]
----
service instance (component) -> executes (relation) -> process (component)
----

Où ?

* Un site `service instance` représente une instance en cours d'exécution d'un service instrumenté.
* Une adresse `process` représente le processus du système d'exploitation qui exécute ce service.
* La relation `executes` indique que l'instance de service est soutenue par un processus spécifique et s'exécute au sein de celui-ci.

Toute cette topologie est dérivée automatiquement des données de trace OpenTelemetry.

== Données de traçage

Outre l'identité du service, la ressource de traçage comprend des attributs au niveau du processus, tels que

* `process.pid`
* `process.executable.name`
* `process.executable.path`
* `process.command_args`
* `process.runtime.name`
* `process.runtime.version`

Ces attributs nous permettent de modéliser la topologie au niveau du processus sans corrélation de portée ou heuristique.

== Des traces à la topologie : le modèle mental

Avant d'écrire une configuration, il est important de comprendre le fonctionnement conceptuel des mappages de topologie.

=== Composants

Un mappage de composants décrit comment un nœud topologique est créé à partir de données télémétriques.

La cartographie de chaque composant :

* Sélectionne les conditions d'utilisation de la télémétrie.
* Extrait des valeurs à l'aide d'expressions.
* Produit un seul composant logique identifié par un identifiant stable.

Dans ce guide :

* Les instances de service sont fournies par le StackPack OpenTelemetry.
* Les processus sont dérivés des attributs des ressources OpenTelemetry.

=== Relations

Un mappage de relation décrit comment une connexion entre deux composants est créée.

Chaque cartographie de relation :

* Résout un problème de `sourceId` et de `targetId`.
* Affecte un type de relation.
* Produit une arête dirigée.

Les relations sont créées une fois que les composants source et cible existent.

== Création de composants de service à partir de traces

=== Définir la notion de "service

Avant d'écrire la cartographie, nous devons prendre une décision en matière de conception.

Dans le cadre de ce guide, un service est défini comme suit :

* Identifié par `service.namespace` + `service.name`.
* Stabilité au fil des déploiements.
* Indépendant des instances de service.

Cela permet de conserver une topologie lisible et une faible cardinalité.

== Composants de l'instance de service

Les composants de l'instance de service sont déjà définis et fournis par l'OpenTelemetry StackPack.

Chaque instance de service :

* Est dérivé de `service.name`, `service.namespace`, et `service.instance.id`.
* Représente une instance concrète d'un service en cours d'exécution.
* Est stable d'un signal à l'autre (traces et métriques).

Comme cette cartographie existe déjà, elle n'est pas redéfinie dans ce guide.
Au lieu de cela, nous construisons sur cette base.

== Création de composants de processus à partir de traces

=== Définir la notion de "processus

Dans le cadre de ce guide, un processus est défini comme suit :

* Identifié par `host.name`, `process.pid` et les métadonnées exécutables.
* Limité à un seul environnement d'exécution.
* Dérivé exclusivement des attributs des ressources OpenTelemetry.

Cela permet de maintenir la topologie à un faible niveau de cardinalité tout en exposant des détails utiles au moment de l'exécution.

=== Cartographie des composantes du processus

Le mappage des composants suivant crée un composant topologique par processus observé.

[,yaml]
----
_type: "OtelComponentMapping"
name: "OTel Process"
description: "Represents an operating system process derived from OpenTelemetry"
identifier: "urn:stackpack:<stackpack-name>:shared:otel-component-mapping:process"
input:
  signal:
    - "TRACES"
  resource:
    condition: |
      'host.name' in resource.attributes &&
      'process.pid' in resource.attributes
    action: "CREATE"
vars:
  - name: "pid"
    value: "${string(int(resource.attributes['process.pid']))}"
  - name: "hostname"
    value: "${resource.attributes['host.name']}"
  - name: "executableName"
    value: >-
      ${
        'process.executable.name' in resource.attributes ?
         resource.attributes['process.executable.name'] :
          'process.command' in resource.attributes ?
           resource.attributes['process.command'] :
            'process.command_args' in resource.attributes ?
             resource.attributes['process.command_args'] :
                resource.attributes['process.executable.path']
      }
output:
  identifier: "urn:opentelemetry:process/${vars.hostname}:${vars.pid}"
  name: "${vars.hostname}/${vars.executableName}:${vars.pid}"
  typeName: "process"
  typeIdentifier: "urn:stackpack:open-telemetry:shared:component-type:process"
  layerName: "Applications"
  domainName: "Open Telemetry"
  required:
    tags:
      - source: "process-component"
        target: "custom"
      - source: "${resource.attributes}"
        pattern: "process.(.*)"
        target: "process.${1}"
expireAfter: 900000
----

==== Comment fonctionne cette cartographie

* Nous traitons uniquement les données de trace (signal TRACES).
* Un composant de processus est créé lorsque `host.name` et `process.pid` sont présents.
* L'identifiant est stable pendant toute la durée du processus.
* Une étiquette personnalisée est ajoutée pour faciliter le filtrage (pour l'étape de vérification).

Remplacez `<stackpack-name>` par le nom de votre StackPack (si vous n'en avez pas encore, utilisez le nom de votre choix, comme `mystackpack`).

== Créer des relations d'exécution

Maintenant que les instances de service et les processus existent en tant que composants, nous pouvons les connecter.

=== L'instance de service exécute le processus

Le mappage suivant crée une relation `executes` entre une instance de service et un processus.

Cette correspondance est adaptée de la relation existante "l'hôte exécute l'instance de service" fournie par l'OpenTelemetry StackPack.

[,yaml]
----
_type: "OtelRelationMapping"
name: "Executes Relation (Service Instance -> Process)"
description: "Service instance executes a process"
identifier: "urn:stackpack:<stackpack-name>:shared:otel-relation-mapping:executes-service-instance"
input:
  signal:
    - "TRACES"
  resource:
    condition: |
      'service.name' in resource.attributes &&
      'host.name' in resource.attributes &&
      'process.pid' in resource.attributes
    action: "CREATE"
vars:
  - name: "namespace"
    value: "${'service.namespace' in resource.attributes && resource.attributes['service.namespace'] != '' ? resource.attributes['service.namespace'] : 'default'}"
  - name: "service"
    value: "${resource.attributes['service.name']}"
  - name: "instanceId"
    value: >-
      ${
        'service.instance.id' in resource.attributes && resource.attributes['service.instance.id'] != '' ?
        resource.attributes['service.instance.id'] :
        resource.attributes['service.name']
      }
  - name: "hostname"
    value: "${resource.attributes['host.name']}"
  - name: "pid"
    value: "${string(int(resource.attributes['process.pid']))}"
output:
  sourceId: "urn:opentelemetry:namespace/${vars.namespace}:service/${vars.service}:serviceInstance/${vars.instanceId}"
  targetId: "urn:opentelemetry:process/${vars.hostname}:${vars.pid}"
  typeName: "executes"
expireAfter: 900000
----

==== Comment fonctionne cette cartographie

* Nous traitons uniquement les données de trace (signal`TRACES` ).
* La relation est créée chaque fois qu'une instance de service et des données de processus sont présentes.
* Aucune corrélation de portée n'est requise.
* L'expression `targetId` doit être la même que l'expression `output.identifier` de la cartographie des composants de processus.

L'identifiant de la relation est construit (automatiquement) à partir de `sourceId` et `targetId`, et se présente sous la forme suivante : `sourceId-relationId`

Remplacez `<stackpack-name>` par le nom de votre StackPack (si vous n'en avez pas encore, utilisez le nom de votre choix, comme `mystackpack`).

== Validation des mappages OTel

Il existe deux options pour valider l'exactitude des mappages avant de les déployer en production.

1. Utilisation de la commande `sts stackpack test-deploy` pour empaqueter, télécharger et installer/mettre à niveau un StackPack contenant les mappages sur une instance {stackstate-product-name} en cours d'exécution.
2. Utilisation des commandes `sts otel-component-mapping apply` et `sts otel-relation-mapping apply` pour créer/mettre à jour les mappages individuellement sur une instance {stackstate-product-name} en cours d'exécution.

=== Tester les mappings ensemble dans un StackPack

En supposant que les deux mappages se trouvent dans votre StackPack, ils peuvent être testés ensemble. Reportez-vous à la documentation xref:/setup/cli/cli-sts.adoc[CLI de StackPack] pour plus d'informations.

En utilisant la commande `sts stackpack test-deploy --yes`, vous pouvez

* Emballer, télécharger et installer/mettre à niveau le StackPack
* Valider les mappages déclaratifs des composants et des relations résidant dans le StackPack (par exemple, exactitude de l'expression, référence correcte des données du signal d'entrée sur la base du filtrage fourni).

[NOTE]
====
La commande `sts stackpack test` ne transmet pas les données de la trace d'exemple par l'intermédiaire des mappages.
Pour vérifier que les mappages produisent la topologie correcte, assurez-vous que les données de trace Open Telemetry sont envoyées à SUSE Observability.
Reportez-vous à la section xref:/setup/custom-integrations/develop.adoc[Développer une intégration personnalisée (StackPack)] pour plus de détails sur l'utilisation de `sts stackpack test`.
====

=== Tester les mappings individuellement

En supposant que les mappages de composants et de relations ci-dessus soient définis dans des fichiers YAML, ils peuvent être appliqués individuellement.

Remplacez `<stackpack-name>` par le nom de votre StackPack (si vous n'en avez pas encore, utilisez le nom de votre choix, comme `mystackpack`).

[,sh]
----
$ sts otel-component-mapping apply -f process-component-mapping.yaml
✅ OTel component mapping upserted successfully! Identifier: urn:stackpack:mystackpack:shared:otel-component-mapping:process, Name: OTel Process

$ sts otel-relation-mapping apply -f process-relation-mapping.yaml
✅ OTel Relation Mapping upserted successfully! Identifier: urn:stackpack:mystackpack:shared:otel-relation-mapping:executes-service-instance, Name: Executes Relation (Service Instance -> Process)
----

== Topologie résultante

Lorsque ces mappings sont appliqués, la topologie résultante forme un graphe de topologie service-processus entièrement dérivé des données de trace.

Par exemple, en utilisant le site `checkoutservice` de l'application de démonstration OTel, la topologie devrait apparaître comme suit :

----
checkoutservice (instance) ─> executes ─> checkoutservice (process)
----

Cette topologie est mise à jour en permanence au fur et à mesure de l'arrivée de nouvelles traces et expire automatiquement lorsque le trafic s'arrête.

=== Visualiser la topologie résultante dans {stackstate-product-name}

Utilisez l'interface utilisateur {stackstate-product-name} pour confirmer visuellement que les mappages se matérialisent dans la topologie attendue.

1. Ouvrez l'interface utilisateur {stackstate-product-name} à la valeur configurée `baseUrl` Helm
2. Dans la barre latérale gauche, cliquez sur `Open Telemetry > Services Instances`
3. Recherchez le site `checkoutservice` dans la liste des instances de service et cliquez sur le nom de l'instance de service pour ouvrir la page Vue d'ensemble du composant/Points forts.
4. Dans la sous-barre de navigation en haut, sélectionnez `Topology`
5. Dans la couche `Outgoing`, un nœud `od-checkoutservice-<hostId>/checkoutservice:1 (process)` doit être visible.
6. Sélectionnez le nœud du processus et cliquez sur `Explore component`
7. Une topologie plus petite visualisant `checkoutservice -> executes -> checkoutservice (process)` devrait être visible.

Voir le guide de xref:/setup/custom-integrations/otelmappings/troubleshooting.adoc[dépannage] pour des conseils de débogage si la topologie ne se matérialise pas comme prévu.

image:custom-integrations/otel-mappings/topology_from_otel_guide_topology_result.png[Résultat de la topologie]

Pour afficher tous les composants de processus créés à la suite de l'application du mappage des composants de processus, utilisez la commande `sts topology inspect` avec un filtre de type.

[,sh]
----
$ sts topology inspect --type process
NAME                                                             | TYPE    | IDENTIFIERS
od-productcatalogservice-cf9d7b456-rlmp5/productcatalogservice:1 | process | urn:opentelemetry:process/od-productcatalogservice-cf9d7b456-rlmp5:1
od-adservice-6c9dfcfdbf-5pdqr//opt/java/openjdk/bin/java:1       | process | urn:opentelemetry:process/od-adservice-6c9dfcfdbf-5pdqr:1
od-frontend-685db864d9-6sh4d/node:17                             | process | urn:opentelemetry:process/od-frontend-685db864d9-6sh4d:17
od-paymentservice-bf8f84b5d-n8k77/node:17                        | process | urn:opentelemetry:process/od-paymentservice-bf8f84b5d-n8k77:17
od-quoteservice-859b8c5c4c-nkmgq/public/index.php:7              | process | urn:opentelemetry:process/od-quoteservice-859b8c5c4c-nkmgq:7
od-checkoutservice-78885bf588-59p9d/checkoutservice:1            | process | urn:opentelemetry:process/od-checkoutservice-78885bf588-59p9d:1
od-accountingservice-7c546cb977-xjp2c/accountingservice:1        | process | urn:opentelemetry:process/od-accountingservice-7c546cb977-xjp2c:1
----

== Nettoyage

Pour supprimer les mappages créés dans ce guide, utilisez les commandes suivantes :

Remplacez `<stackpack-name>` par le nom de votre StackPack.

[,sh]
----
$ sts otel-component-mapping delete --identifier urn:stackpack:<stackpack-name>:shared:otel-component-mapping:process
✅ OTel Component Mapping deleted: urn:stackpack:mystackpack:shared:otel-component-mapping:process

$ sts otel-relation-mapping delete --identifier urn:stackpack:<stackpack-name>:shared:otel-relation-mapping:executes-service-instance
✅ OTel Relation Mapping deleted: urn:stackpack:mystackpack:shared:otel-relation-mapping:executes-service-instance
----


== Résumé

Dans ce guide, vous :

* Construit à partir de composants d'instance de service existants.
* Composants de processus dérivés des attributs de ressources OpenTelemetry.

== Prochaines étapes

À partir de là, vous pouvez :

* Attacher des processus à des hôtes ou à des conteneurs.
* Introduire une base de données ou des relations de messagerie.
* Introduire des couches spécifiques à l'exécution (JVM, Go, Node.js).
* Explorer les graphiques de services basés sur des mesures.
* Étendre le StackPack avec des couches topologiques supplémentaires.
* Familiarisez-vous avec une xref:/setup/custom-integrations/otelmappings/schemas-ref.adoc[référence] approfondie xref:/setup/custom-integrations/otelmappings/schemas-ref.adoc[de la] cartographie des composants et des relations.

endif::ss-ff-stackpacks2_enabled[]
