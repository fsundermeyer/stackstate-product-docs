= SUSE Observability en tant que source de données Grafana
:revdate: 2025-07-10
:page-revdate: {revdate}
:description: Utiliser SUSE Observability comme source de données Grafana

SUSE Observability peut être utilisé comme source de données pour Grafana. Cela vous permettra d'utiliser Grafana comme outil de visualisation pour vos données SUSE Observability. Cette fonction est utile si vous avez déjà des tableaux de bord que vous souhaitez continuer à utiliser. Étant donné que SUSE Observability expose une API compatible avec Prometheus, vous pouvez utiliser la https://grafana.com/docs/grafana/latest/datasources/prometheus[source de données] dans Grafana pour vous connecter à SUSE Observability. Cela permet également d'utiliser SUSE Observability avec d'autres solutions compatibles avec Prometheus.

== Conditions préalables

Avant d'ajouter SUSE Observability en tant que source de données dans Grafana, vous devez configurer un ServiceToken pour vous authentifier auprès de SUSE Observability. SUSE Observability recommande de créer un rôle dédié avec des autorisations à cet effet.

Vous pouvez le faire via le CLI de SUSE Observability :

[,sh]
----
> sts rbac create-subject --subject grafana
✅ Created subject 'grafana'
> sts rbac grant --subject grafana --permission get-metrics
✅ Granted permission 'get-metrics' on 'system' to subject 'grafana'
PERMISSION  | RESOURCE
get-metrics | system
----

Cela créera un nouveau rôle dans SUSE Observability appelé `grafana` et lui accordera l'autorisation `get-metrics`. Vous pouvez ensuite créer un ServiceToken pour ce rôle :

[,sh]
----
> sts service-token create --name grafana --roles grafana
✅ Service token created: svctok-XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
----

En savoir plus sur la xref:/use/security/k8s-service-tokens.adoc[gestion des ServiceTokens].

Le ServiceToken renvoyé peut être utilisé pour s'authentifier auprès de SUSE Observability. Vous pouvez désormais ajouter SUSE Observability en tant que source de données dans Grafana.

== Créer une nouvelle source de données SUSE Observability dans Grafana

Avec le ServiceToken créé, vous pouvez maintenant ajouter SUSE Observability comme source de données dans Grafana. Pour ce faire, allez dans l'interface utilisateur de Grafana et naviguez jusqu'à la page de configuration de la source de données. Cliquez sur le bouton `Add data source` et sélectionnez `Prometheus` dans la liste des sources de données.

image::k8s/k8s-grafana-new-datasource.png[Nouvelle source de données Grafana]

Sur la page de configuration de la source de données, entrez les détails de configuration suivants :

* *Nom*: SUSE Observability
* *URL*: `https://<tenant-name>.app.stackstate.io/prometheus`
* *En-têtes HTTP personnalisés*
 ** *En-tête*: `X-API-Key`
 ** *Valeur*: `<service-token>`

image::k8s/k8s-grafana-datasource.png[Configuration de la source de données Grafana]

Cliquez sur le bouton `Save & Test` pour enregistrer la source de données. Si la configuration est correcte, un message vert s'affiche à l'adresse `Data source is working`.

== Restreindre l'accès aux mesures

Lorsque vous utilisez xref:/setup/security/rbac/rbac_rancher.adoc[Rancher RBAC], il est possible d'accorder l'accès aux métriques au niveau d'un cluster ou d'un espace de noms.

Pour autoriser l'accès à toutes les mesures d'un cluster :
[,sh]
----
> sts rbac grant --subject grafana --permission get-metrics --resource k8s:YOUR_CLUSTER:__any__
✅ Granted permission 'get-metrics' on 'k8s:YOUR_CLUSTER:__any__' to subject 'grafana'
PERMISSION  | RESOURCE
get-metrics | k8s:YOUR_CLUSTER:__any__
----

Pour autoriser l'accès à toutes les mesures d'un espace de noms :
[,sh]
----
> sts rbac grant --subject grafana --permission get-metrics --resource k8s:OTHER_CLUSTER:SINGLE_NAMESPACE
✅ Granted permission 'get-metrics' on 'k8s:OTHER_CLUSTER:SINGLE_NAMESPACE' to subject 'grafana'
PERMISSION  | RESOURCE
get-metrics | k8s:OTHER_CLUSTER:SINGLE_NAMESPACE
----

Inspecter toutes les autorisations qui ont été accordées au sujet :
[,sh]
----
> sts rbac describe-permissions --subject grafana
PERMISSION  | RESOURCE
get-metrics | k8s:OTHER_CLUSTER:YOUR_NAMESPACE
get-metrics | k8s:YOUR_CLUSTER:__any__
----
