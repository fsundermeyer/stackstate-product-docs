= Prometheus remote_write
:revdate: 2025-07-10
:page-revdate: {revdate}
:description: SUSE Observability

Si vous disposez de votre propre Prometheus sur site ou auto-hébergé, dans lequel les métriques de votre environnement sont agrégées, vous pouvez refléter ces métriques dans SUSE Observability. Vous pourrez ainsi utiliser les puissantes fonctionnalités de topologie et de corrélation de SUSE Observability pour dépanner votre environnement Kubernetes sans avoir à passer d'un outil à l'autre.

Pour ce faire, SUSE Observability expose le protocole Prometheus `remote_write` en tant que point final. Ce point d'accès vous permet de configurer votre instance Prometheus pour qu'elle envoie des mesures à SUSE Observability. Les mesures sont alors automatiquement intégrées et il sera possible de les lier aux composants observés par SUSE Observability. Le diagramme suivant montre comment cela fonctionne :

image::k8s/k8s-prometheus-remotewrite.png[Prometheus Remote Write]

== Conditions préalables

Pour refléter vos métriques Prometheus dans SUSE Observability, vous devez rechercher la clé API utilisée pour envoyer les métriques dans SUSE Observability. La clé API se trouve dans la description du StackPack Kubernetes installé dans SUSE Observability. Les étapes suivantes montrent comment trouver la clé API :

. Ouvrez l'interface utilisateur de SUSE Observability et accédez à la page StackPacks.
+
image::k8s/k8s-stackpacks.png[StackPacks]

. Trouvez le StackPack Kubernetes et cliquez dessus.
. Dans la description du StackPack, vous trouverez la clé API utilisée pour envoyer des métriques à SUSE Observability.
+
image::k8s/k8s-stackpacks-apikey.png[Clé API]

== Configuration de votre instance Prometheus

Pour configurer votre instance Prometheus afin qu'elle envoie des mesures à SUSE Observability, vous devez ajouter un nouveau point de terminaison d'écriture à distance à votre configuration Prometheus. Pour ce faire, il suffit de mettre à jour la section `remote_write` de votre fichier `prometheus.yml`. Vous pouvez utiliser deux variantes pour l'authentification du point final, soit par le biais d'un en-tête, soit par l'authentification de base.

=== Authentification de l'en-tête

Vous pouvez vous authentifier à l'aide de la clé API en ajoutant l'en-tête `sts-api-key` aux requêtes prometheus remote_write. L'exemple suivant montre comment configurer cela :

[,yaml]
----
remote_write:
- url: https://<tenant>.app.stackstate.io/receiver/prometheus/api/v1/write
  headers:
    sts-api-key: <API Key>
----

=== Authentification de base

Vous pouvez vous authentifier à l'aide de l'authentification de base en ajoutant la section `basic_auth` aux demandes prometheus remote_write. Étant donné que les demandes adressées à cette API sont effectuées à partir d'un service sans tête, le champ du nom d'utilisateur est défini sur la valeur statique `apikey`. L'exemple suivant montre comment configurer cela :

[,yaml]
----
remote_write:
- url: https://<tenant>.app.stackstate.io/receiver/prometheus/api/v1/write
  basic_auth:
    username: apikey
    password: <API Key>
----

== Finition

Une fois les changements de configuration appliqués au fichier de configuration de Prometheus, Prometheus doit être redémarré. Après le redémarrage, Prometheus commencera à envoyer des mesures à SUSE Observability. Les mesures seront automatiquement mises en corrélation avec le reste de votre environnement et seront visibles dans l'interface utilisateur de SUSE Observability.
